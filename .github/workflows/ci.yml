# ê° ì„œë¹„ìŠ¤ ë ˆí¬ì˜ .github/workflows/ci.yml

name: Build and Deploy to ECR

on:
  push:
    branches: [main, master]

env:
  AWS_REGION: ap-southeast-2 # ì‹œë“œë‹ˆ ë¦¬ì „
  ECR_REPOSITORY: winter-cat # ê³ ì •ëœ ECR ë ˆí¬ ì´ë¦„

jobs:
  build:
    runs-on: ubuntu-latest
    environment: production # Environment secrets ì‚¬ìš©
    outputs:
      image-tag: ${{ steps.tag.outputs.tag }}
      image-uri: ${{ steps.build.outputs.image-uri }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create config-prod.json
        run: |
          echo '${{ secrets.CONFIG_PROD_JSON }}' > config-prod.json

      - name: Generate unique image tag
        id: tag
        run: |
          TAG="v$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA::7}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Generated tag: ${TAG}"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image to Amazon ECR
        id: build
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.tag.outputs.tag }}
          SERVICE_NAME: ${{ github.event.repository.name }}
        run: |
          # Build a docker container and push it to ECR
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$SERVICE_NAME-$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$SERVICE_NAME-$IMAGE_TAG

          # Tag as latest for each service
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$SERVICE_NAME-$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:$SERVICE_NAME-latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$SERVICE_NAME-latest

          echo "image-uri=$ECR_REGISTRY/$ECR_REPOSITORY:$SERVICE_NAME-$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "Image pushed: $ECR_REGISTRY/$ECR_REPOSITORY:$SERVICE_NAME-$IMAGE_TAG"

  update-helm-chart:
    needs: build
    runs-on: ubuntu-latest
    environment: production # Environment secrets ì‚¬ìš©
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Update Helm Chart
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          # Helm Charts ë ˆí¬ì§€í† ë¦¬ í´ë¡ 
          git clone https://${{ secrets.HELM_REPO_TOKEN }}@github.com/${{ secrets.HELM_REPO }}.git helm-repo
          cd helm-repo

          SERVICE_NAME="${{ github.event.repository.name }}"
          NEW_TAG="${{ needs.build.outputs.image-tag }}"
          NEW_REPOSITORY="${ECR_REGISTRY}/winter-cat"

          # values.yamlì—ì„œ í•´ë‹¹ ì„œë¹„ìŠ¤ì˜ repositoryì™€ tag ì—…ë°ì´íŠ¸
          case $SERVICE_NAME in
            "discord-bot")
              sed -i "/discordBot:/,/pullPolicy:/ {
                s|repository: .*|repository: ${NEW_REPOSITORY}|
                s|tag: .*|tag: discord-bot-${{ needs.build.outputs.image-tag }}|
              }" values.yaml
              ;;
            "winter-cat-video")
              sed -i "/winterCatVideo:/,/pullPolicy:/ {
                s|repository: .*|repository: ${NEW_REPOSITORY}|
                s|tag: .*|tag: winter-cat-video-${{ needs.build.outputs.image-tag }}|
              }" values.yaml
              ;;
            "codex-media")
              sed -i "/codexMedia:/,/pullPolicy:/ {
                s|repository: .*|repository: ${NEW_REPOSITORY}|
                s|tag: .*|tag: codex-media-${{ needs.build.outputs.image-tag }}|
              }" values.yaml
              ;;
          esac

          # Chart.yaml ë²„ì „ ì—…ë°ì´íŠ¸
          CHART_VERSION="0.1.$(date +%Y%m%d%H%M%S)"
          sed -i "s|version: .*|version: ${CHART_VERSION}|g" Chart.yaml
          sed -i "s|appVersion: .*|appVersion: \"${NEW_TAG}\"|g" Chart.yaml

          # Git ì»¤ë°‹
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Update ${SERVICE_NAME} to ${NEW_TAG}

          - ECR Repository: ${NEW_REPOSITORY}
          - Image Tag: ${SERVICE_NAME}-${NEW_TAG}
          - Commit: ${{ github.sha }}" || exit 0
          git push

          echo "âœ… Updated ${SERVICE_NAME} to ${SERVICE_NAME}-${NEW_TAG}"

  notify:
    needs: [build, update-helm-chart]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Discord success notification
        if: needs.build.result == 'success' && needs.update-helm-chart.result == 'success'
        run: |
          curl -H "Content-Type: application/json" \
               -d "{
                 \"embeds\": [{
                   \"title\": \"âœ… ECR ë°°í¬ ì„±ê³µ: ${{ github.event.repository.name }}\",
                   \"description\": \"ìƒˆ ì´ë¯¸ì§€ê°€ winter-cat ECRì— í‘¸ì‹œë˜ê³  Helm ì°¨íŠ¸ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.\",
                   \"color\": 5763719,
                   \"fields\": [
                     {\"name\": \"ğŸ·ï¸ ì´ë¯¸ì§€ íƒœê·¸\", \"value\": \"\`${{ github.event.repository.name }}-${{ needs.build.outputs.image-tag }}\`\", \"inline\": true},
                     {\"name\": \"ğŸ“¦ ECR URI\", \"value\": \"\`${{ needs.build.outputs.image-uri }}\`\", \"inline\": false},
                     {\"name\": \"ğŸ“ ì»¤ë°‹\", \"value\": \"\`${{ github.sha }}\`\", \"inline\": true},
                     {\"name\": \"ğŸ‘¤ ì‘ì„±ì\", \"value\": \"${{ github.actor }}\", \"inline\": true}
                   ]
                 }]
               }" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Discord failure notification
        if: needs.build.result == 'failure' || needs.update-helm-chart.result == 'failure'
        run: |
          curl -H "Content-Type: application/json" \
               -d "{
                 \"embeds\": [{
                   \"title\": \"âŒ ECR ë°°í¬ ì‹¤íŒ¨: ${{ github.event.repository.name }}\",
                   \"description\": \"winter-cat ECR ì´ë¯¸ì§€ ë¹Œë“œ ë˜ëŠ” Helm ì°¨íŠ¸ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\",
                   \"color\": 15158332,
                   \"fields\": [
                     {\"name\": \"ğŸ“ ì»¤ë°‹\", \"value\": \"\`${{ github.sha }}\`\", \"inline\": true},
                     {\"name\": \"ğŸ‘¤ ì‘ì„±ì\", \"value\": \"${{ github.actor }}\", \"inline\": true}
                   ]
                 }]
               }" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}
